<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
        <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
        <title><%= locals.headTitle.pageName %><%= locals.headTitle.remainder %></title>
    </head>
    <body class="container mb-5 pb-5">
        <div class="this-will-be-navbar my-5 d-flex flex-column justify-content-center align-items-center">
            <h1><a href="/">NextTrack</a></h1>
        </div>

        <div class="submitted-track-details my-5">
            <h3>Track's Details</h3>
            <ul>
                <li>Name: <%= spotify_trackDetails.name %></li>
                <li>
                    Artist(s): <% spotify_trackDetails.artists.forEach((artist, index) => { %>
                    <!-- Format -->
                    <% let comma_space = index == spotify_trackDetails.artists.length - 1 ? "" : ", " %>
                    <!-- Format -->
                    <%= artist.name %><%= comma_space %>
                    <!-- Format -->
                    <% }) %>
                </li>
                <li>Release Date (YYYY-MM-DD): <%= spotify_trackDetails.album.release_date %></li>
            </ul>
        </div>

        <div class="row">
            <div class="customise-your-recommendations col-md-6">
                <h3>Customise Your Recommendations</h3>
                <p>How similar do you want your recommendations to be?</p>
                <!--
                TODO
                Double-click to reset slider's value.
                Upon form submission, put slider (and other param) values in URL via something like `?=`.
                Then, with those `?=` in the URL, page refreshing will set it at that value.
                -->

                <!-- Adding `autocomplete="off"` ensures slider (and other GUI) values are reset upon page refresh -->
                <form id="customizeForm" autocomplete="off">
                    <button type="button" class="btn btn-primary" onclick="submitParams()">Update Recommendations</button>

                    <div class="form-group m-5">
                        <div class="similarity-slider">
                            <h4>Genres / Tags</h4>
                            <span>Current: </span>
                            <ul>
                                <% if (lastFm_genreTags.length == 0) { %>
                                <li><i>None</i></li>
                                <% } else { %>
                                <!-- Format -->
                                <% lastFm_genreTags.forEach((genreTag) => { %>
                                <li><%= genreTag.name %></li>
                                <% }) %>
                                <!-- Format -->
                                <% } %>
                            </ul>
                            <label for="similaritySlider" class="form-label">
                                <span>Recommended Similarity: </span>
                                <span id="similaritySliderValue">100</span>%
                            </label>
                            <input name="similaritySlider" id="similaritySlider" type="range" class="form-range" min="0" max="100" step="1" value="100" />
                        </div>
                    </div>

                    <div class="form-group m-5">
                        <h4>Popularity</h4>
                        <span>Current: <%= spotify_trackDetails.popularity %> / 100</span>
                        <div class="popularity-slider">
                            <label for="popularitySlider" class="form-label">
                                <span>Recommended: </span>
                                <span id="popularitySliderValue"><%= spotify_trackDetails.popularity %></span>
                                <span> / 100</span>
                            </label>
                            <input name="popularitySlider" id="popularitySlider" type="range" class="form-range" min="0" max="100" step="1" value="<%= spotify_trackDetails.popularity %>" />
                        </div>
                    </div>

                    <div class="form-group m-5">
                        <h4>WIP TODO: More params (e.g. date range for Release Year)</h4>
                        <label for="dateRangeSlider" class="form-label">
                            <span id="dateRangeSliderValue">2000</span>
                        </label>
                        <input name="dateRangeSlider" id="dateRangeSlider" type="range" class="form-range" min="1970" max="2025" step="1" value="2000" />
                    </div>

                    <div class="form-group m-5">
                        <h4>WIP TODO: More params (e.g. checkboxes for Moods)</h4>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="happy" id="moodHappy" />
                            <label class="form-check-label" for="moodHappy">Happy</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="sad" id="moodSad" />
                            <label class="form-check-label" for="moodSad">Sad</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="party" id="moodParty" />
                            <label class="form-check-label" for="moodParty">Party</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="chill" id="moodChill" />
                            <label class="form-check-label" for="moodChill">Chill</label>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="submitParams()">Update Recommendations</button>
                </form>
            </div>

            <div class="recommended-tracks col-md-6">
                <h3>Recommended Tracks</h3>

                <% dummyRecommendedTracks.forEach((dummyRecommendedTrack, index) => { %>
                <div class="recommended-track mb-5 p-4 border">
                    <!-- Always visible -->
                    <div class="toggle-header d-flex justify-content-between align-items-center" role="button" data-bs-toggle="collapse" data-bs-target="#collapseTrack<%= index %>" aria-expanded="false" aria-controls="collapseTrack<%= index %>">
                        <div>
                            <h4><%= dummyRecommendedTrack.name %></h4>
                            <p>by <%= dummyRecommendedTrack.artist %></p>
                        </div>
                        <i class="bi bi-chevron-down chevron-icon"></i>
                    </div>
                    <div>
                        Listen at
                        <a class="btn btn-outline-success btn-sm" href="<%= dummyRecommendedTrack.link.spotify %>" target="_blank">Spotify</a>
                        <a class="btn btn-outline-danger btn-sm" href="<%= dummyRecommendedTrack.link.appleMusic %>" target="_blank">Apple Music</a>
                        <a class="btn btn-outline-warning btn-sm" href="<%= dummyRecommendedTrack.link.youtubeMusic %>" target="_blank">YouTube Music</a>
                    </div>

                    <!-- Collapsible -->
                    <div class="collapse mt-3" id="collapseTrack<%= index %>">
                        <p>
                            <iframe width="560" height="315" src="https://www.youtube.com/embed/<%= dummyRecommendedTrack.link.video %>" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        </p>
                        <!-- NOTE: Temporarily put here because Genius' lyrics is huge -->
                        <p>
                            About:
                            <a href="<%= dummyRecommendedTrack.about.genius %>">Genius</a>
                            or
                            <a href="<%= dummyRecommendedTrack.about.lastFm %>">Last.fm</a>.
                        </p>
                        <!-- NOTE: Temporarily put here because Genius' lyrics is huge -->
                        <p>
                            Comments:
                            <a href="<%= dummyRecommendedTrack.comments.genius %>">Genius</a>
                            or
                            <a href="<%= dummyRecommendedTrack.comments.lastFm %>">Last.fm</a>.
                        </p>
                        <!-- TODO: Genius' embed defaults to light mode, try see if it can be manipulated to dark mode -->
                        <div class="text-dark">
                            <div id="rg_embed_link_1063" class="rg_embed_link" data-song-id="1063">HELLO</div>
                            <script crossorigin src="//genius.com/songs/1063/embed.js"></script>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>

        <script>
            function attachSlider(sliderId, valueId) {
                let slider = document.getElementById(sliderId);
                let value = document.getElementById(valueId);
                if (slider && value) {
                    // Set initial value
                    value.textContent = slider.value;
                    slider.addEventListener("input", () => {
                        value.textContent = slider.value;
                    });
                }
            }
            attachSlider("similaritySlider", "similaritySliderValue");
            attachSlider("popularitySlider", "popularitySliderValue");
            attachSlider("dateRangeSlider", "dateRangeSliderValue");

            function submitParams() {
                let similarity = document.getElementById("similaritySlider").value;
                let popularity = document.getElementById("popularitySlider").value;
                let dateRange = document.getElementById("dateRangeSlider").value;
                let moods = [];
                ["Happy", "Sad", "Party", "Chill"].forEach((mood) => {
                    let checkbox = document.getElementById("mood" + mood);
                    if (checkbox.checked) moods.push(checkbox.value);
                });

                // Insert param values into URL
                let newUrl = `${window.location.pathname}?similarity=${similarity}&popularity=${popularity}&dateRange=${dateRange}&moods=${moods.join(",")}`;
                window.location.href = newUrl;
            }

            document.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll(".toggle-header").forEach((header) => {
                    const chevron = header.querySelector(".chevron-icon");
                    const targetId = header.getAttribute("data-bs-target");
                    const collapseElem = document.querySelector(targetId);
                    collapseElem.addEventListener("show.bs.collapse", () => {
                        chevron.classList.remove("bi-chevron-down");
                        chevron.classList.add("bi-chevron-up");
                    });
                    collapseElem.addEventListener("hide.bs.collapse", () => {
                        chevron.classList.remove("bi-chevron-up");
                        chevron.classList.add("bi-chevron-down");
                    });
                });
            });
        </script>
    </body>
</html>
